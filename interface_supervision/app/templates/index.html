<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Interface de supervision</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
    }
    header {
      background: linear-gradient(90deg, #2f855a, #38a169);
      color: white;
      padding: 30px;
      text-align: center;
      font-size: 2em;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .section {
      background: #fff;
      margin: 30px auto;
      padding: 30px;
      max-width: 1000px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      animation: fadeIn 0.6s ease;
    }
    .pdf-export {
      background: #ffffff !important;
      box-shadow: none !important;
      animation: none !important;
      color: black !important;
    }
    select, button {
      padding: 10px 16px;
      margin: 10px 5px;
      border: none;
      border-radius: 8px;
      background: #2f855a;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1em;
    }
    select:hover, button:hover {
      background: #276749;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .stat-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      padding: 20px;
      border-radius: 12px;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: 0.3s;
    }
    .stat-card:hover { transform: scale(1.05); }
    .temp-min { background-color: #c6f6d5; }
    .temp-max { background-color: #feb2b2; }
    .temp-avg { background-color: #bee3f8; }
    .hum-min  { background-color: #e6fffa; }
    .hum-max  { background-color: #fff5f5; }
    .hum-avg  { background-color: #ebf4ff; }
    .measurements-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }
    .sensor-section {
      border-top: 2px solid #38a169;
      padding-top: 10px;
    }
    .sensor-title {
      font-size: 1.2em;
      color: #2f855a;
      margin-bottom: 10px;
    }
    .sensor-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    .measurement-card {
      background: #f9fafb;
      border: 2px solid #38a169;
      border-radius: 12px;
      padding: 20px;
      text-align: left;
      font-size: 1em;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s;
      position: relative;
    }
    .measurement-card:hover {
      transform: scale(1.05);
      background: #e6f7e6;
    }
    .latest {
      background-color: #e6ffed;
      border: 3px solid #2f855a;
      box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
    }
    .latest::before {
      content: "üîÑ Derni√®re";
      position: absolute;
      top: -10px;
      left: 10px;
      background: #2f855a;
      color: white;
      font-size: 0.75em;
      padding: 2px 8px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .anomaly-item {
      margin-bottom: 10px;
      padding: 10px;
      background: #fff5f5;
      border-left: 5px solid #e53e3e;
      border-radius: 5px;
    }
    canvas {
      width: 100% !important;
      max-height: 400px;
    }
    .plant-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .plant-tile {
      background: #f0fff4;
      border: 2px solid #38a169;
      border-radius: 12px;
      padding: 25px 10px;
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .plant-tile:hover {
      transform: scale(1.05);
      background: #c6f6d5;
    }
    .plant-info {
      margin-top: 15px;
      font-size: 1em;
      color: #2f855a;
      text-align: center;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header><h1>üåø Interface de supervision</h1></header>

  <div class="section">
    <h2>ü™¥ Plantes de la ferme</h2>
    <div class="plant-grid" id="plant-grid"></div>
    <div id="plant-info" class="plant-info">Survolez une plante pour voir ses donn√©es</div>
  </div>

  <div class="section" id="report-content">
    <h2>üå°Ô∏è Mesures</h2>
    <label for="sensor-filter">Filtrer par capteur :</label>
    <select id="sensor-filter"><option value="all">Tous</option></select>
    <button id="refresh-btn">üîÑ Rafra√Æchir</button>
    <button id="export-json-btn">üì§ JSON</button>
    <button id="export-csv-btn">üì§ CSV</button>
    <button id="pdf-btn">üìÑ PDF</button>

    <div id="measurements-list" class="measurements-list"></div>
    <canvas id="chart"></canvas>

    <div id="stats">
      <h3>üìä Statistiques (capteur s√©lectionn√©)</h3>
      <div id="stats-cards" class="stat-cards"></div>
    </div>
  </div>

  <div class="section">
    <h2>üö® Anomalies</h2>
    <ul id="anomalies-list"></ul>
  </div>

  <script>
    let latestMeasurements = [];

    const avg = arr => arr.reduce((a, b) => a + b, 0) / arr.length;

    async function loadData() {
      const sensors = await fetch('/sensors').then(res => res.json());
      const measurementsRes = await fetch('/measurements').then(res => res.json());
      const measurements = measurementsRes.data || [];
      latestMeasurements = measurements;

      const filterSelect = document.getElementById('sensor-filter');
      const currentValue = filterSelect.value || "all";
      filterSelect.innerHTML = '<option value="all">Tous</option>';
      sensors.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.sensor_id;
        opt.textContent = `Capteur ${s.sensor_id}`;
        filterSelect.appendChild(opt);
      });
      filterSelect.value = currentValue;

      const selectedSensor = filterSelect.value;
      const filtered = selectedSensor === 'all' ? measurements : measurements.filter(m => m.sensor_id == selectedSensor);

      const grouped = {};
      filtered.forEach(m => {
        if (!grouped[m.sensor_id]) grouped[m.sensor_id] = [];
        grouped[m.sensor_id].push(m);
      });

      const container = document.getElementById('measurements-list');
      container.innerHTML = '';
      for (const [sensorId, values] of Object.entries(grouped)) {
        const last4 = values.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 4);
        const section = document.createElement('div');
        section.className = 'sensor-section';
        section.innerHTML = `
          <div class="sensor-title">Capteur ${sensorId}</div>
          <div class="sensor-cards">
            ${last4.map((m, i) => `
              <div class="measurement-card ${i === 0 ? 'latest' : ''}">
                <strong>${m.timestamp}</strong><br>
                Capteur : ${m.sensor_id} | üå°Ô∏è ${m.temperature}¬∞C | üíß ${m.humidity}%
              </div>
            `).join('')}
          </div>
        `;
        container.appendChild(section);
      }

      renderChart(filtered);
      renderStats(filtered);
      renderAnomalies(filtered);
      renderPlants(measurements);
    }

    function renderAnomalies(data) {
      const list = document.getElementById('anomalies-list');
      list.innerHTML = '';
      const selectedSensor = document.getElementById('sensor-filter').value;
      const filtered = selectedSensor === 'all' ? data : data.filter(a => a.sensor_id == selectedSensor);

      const anomalies = filtered
        .filter(a => a.temperature > 40 || a.humidity < 20)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 10);

      if (anomalies.length === 0) {
        list.innerHTML = '<li style="color: #718096;">Aucune anomalie d√©tect√©e r√©cemment.</li>';
        return;
      }

      anomalies.forEach(a => {
        const li = document.createElement('li');
        li.className = 'anomaly-item';
        li.innerHTML = `
          <strong>${a.timestamp}</strong> |
          Plante : <strong>${a.plant_id}</strong> |
          Capteur : <strong>${a.sensor_id}</strong> |
          üå°Ô∏è ${a.temperature}¬∞C |
          üíß ${a.humidity}%
        `;
        list.appendChild(li);
      });
    }

    function renderPlants(measurements) {
      const grid = document.getElementById("plant-grid");
      const info = document.getElementById("plant-info");
      grid.innerHTML = '';
      const displayedPlants = [1, 2, 3, 4, 5, 6];
      displayedPlants.forEach(plantId => {
        const tile = document.createElement("div");
        tile.className = "plant-tile";
        tile.textContent = `üåø Plante ${plantId}`;
        tile.addEventListener("mouseenter", () => {
          const latest = measurements
            .filter(m => m.plant_id == plantId)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
          if (latest) {
            info.innerHTML = `
              <strong>Capteur:</strong> ${latest.sensor_id} |
              <strong>Version:</strong> ${latest.version || "N/A"} |
              <strong>Plante:</strong> ${plantId}<br>
              üå°Ô∏è ${latest.temperature} ¬∞C | üíß ${latest.humidity} %<br>
              <em>Mesure du ${new Date(latest.timestamp).toLocaleString('fr-FR')}</em>
            `;
          } else {
            info.textContent = "Aucune donn√©e disponible.";
          }
        });
        tile.addEventListener("mouseleave", () => {
          info.textContent = "Survolez une plante pour voir ses donn√©es";
        });
        grid.appendChild(tile);
      });
    }

    function renderChart(data) {
      const ctx = document.getElementById('chart').getContext('2d');
      const labels = data.map(m => m.timestamp);
      const datasets = [
        {
          label: 'Temp√©rature (¬∞C)',
          data: data.map(m => m.temperature),
          borderColor: 'red',
          backgroundColor: 'rgba(255,0,0,0.2)',
          tension: 0.3,
          pointRadius: 4
        },
        {
          label: 'Humidit√© (%)',
          data: data.map(m => m.humidity),
          borderColor: 'blue',
          backgroundColor: 'rgba(0,0,255,0.2)',
          tension: 0.3,
          pointRadius: 4
        }
      ];
      if (window.chartInstance) window.chartInstance.destroy();
      window.chartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: '√âvolution Temp√©rature / Humidit√©' }
          }
        }
      });
    }

    function renderStats(data) {
      const statsContainer = document.getElementById('stats-cards');
      statsContainer.innerHTML = '';
      if (!data.length) return statsContainer.innerHTML = 'Aucune donn√©e.';
      const temp = data.map(d => d.temperature);
      const hum = data.map(d => d.humidity);
      const statItems = [
        { label: 'üå°Ô∏è Moyenne', value: avg(temp).toFixed(1) + ' ¬∞C', class: 'temp-avg' },
        { label: 'üå°Ô∏è Min', value: Math.min(...temp) + ' ¬∞C', class: 'temp-min' },
        { label: 'üå°Ô∏è Max', value: Math.max(...temp) + ' ¬∞C', class: 'temp-max' },
        { label: 'üíß Moyenne', value: avg(hum).toFixed(1) + ' %', class: 'hum-avg' },
        { label: 'üíß Min', value: Math.min(...hum) + ' %', class: 'hum-min' },
        { label: 'üíß Max', value: Math.max(...hum) + ' %', class: 'hum-max' }
      ];
      statItems.forEach(s => {
        const div = document.createElement('div');
        div.className = `stat-card ${s.class}`;
        div.innerHTML = `<div>${s.label}</div><div>${s.value}</div>`;
        statsContainer.appendChild(div);
      });
    }

    document.getElementById('refresh-btn').addEventListener('click', loadData);
    document.getElementById('sensor-filter').addEventListener('change', loadData);
    document.getElementById('export-json-btn').addEventListener('click', () => {
      if (!latestMeasurements.length) return alert("Aucune donn√©e √† exporter.");
      const blob = new Blob([JSON.stringify(latestMeasurements, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'mesures.json';
      a.click();
    });
    document.getElementById('export-csv-btn').addEventListener('click', () => {
      if (!latestMeasurements.length) return alert("Aucune donn√©e √† exporter.");
      const csv = ["timestamp,sensor_id,plant_id,temperature,humidity,version"];
      latestMeasurements.forEach(m => {
        csv.push(`${m.timestamp},${m.sensor_id},${m.plant_id},${m.temperature},${m.humidity},${m.version || "N/A"}`);
      });
      const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'mesures.csv';
      a.click();
    });
    document.getElementById('pdf-btn').addEventListener('click', () => {
      const element = document.getElementById('report-content');
      element.classList.add('pdf-export');
      html2pdf().set({
        margin: 0.5,
        filename: 'rapport-supervision.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      }).from(element).save().then(() => {
        element.classList.remove('pdf-export');
      });
    });

    loadData();
    setInterval(loadData, 12000);
  </script>
</body>
</html>